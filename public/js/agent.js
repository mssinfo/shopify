!function(){function t(t){return fetch(t).then(function(t){return t.json()}).catch(function(){return[]})}document.addEventListener("DOMContentLoaded",function(){try{!function(){var e=document.getElementById("agent-shop-search");if(e){var n,a=document.getElementById("agent-shop-suggestions"),s=document.getElementById("agent-shop-detail"),o=document.getElementById("agent-shop-detail-body"),i=document.getElementById("agent-shop-clear"),c=document.querySelector("#recent-shops-table tbody"),l=document.getElementById("shop-activity-chart"),r=null;e.addEventListener("input",function(n){var i=n.target.value.trim();clearTimeout(r),i.length<2?a&&(a.innerHTML=""):r=setTimeout(function(){t(window.AgentConfig.urls.shopsSearch+"?q="+encodeURIComponent(i)+"&limit=8").then(function(n){a&&(a.innerHTML="",Array.isArray(n)&&n.length&&n.forEach(function(n){var i=document.createElement("button");i.type="button",i.className="list-group-item list-group-item-action",i.innerHTML='<div class="d-flex justify-content-between"><div>'.concat(n.name||n.shop,' <a href="https://').concat(n.shop,'" target="_blank">ðŸ”—</a> <div class="small text-muted">').concat(n.domain||"",'</div></div><div class="small text-muted">ID ').concat(n.id,"</div></div>"),i.addEventListener("click",function(){t(window.AgentConfig.urls.shopsBase+"/"+n.id).then(function(t){a.innerHTML="",e.value="",function(t){var e;if(t){null==s||s.classList.remove("d-none");var n="";n+="<h5>".concat(t.shop,' <small class="text-muted">ID ').concat(t.id,"</small></h5>"),n+='<p class="mb-1"><strong>Domain:</strong> '.concat(t.domain||"N/A","</p>"),n+='<p class="mb-1"><strong>Active Plan:</strong> '.concat((null===(e=t.activeCharge)||void 0===e?void 0:e.name)||"N/A","</p>");var a=t.uninstalled||t.is_uninstalled||!1,i=t.uninstalled_at||t.deleted_at||null;n+=a?'<p class="mb-1"><strong>Status:</strong> <span class="badge bg-danger">Uninstalled</span> '.concat(i?'<div class="small text-muted">On '+new Date(i).toLocaleString()+"</div>":"","</p>"):'<p class="mb-1"><strong>Status:</strong> <span class="badge bg-success">Active</span></p>';var c=t.access_token||t.token||null;if(c){var l=/^https?:\/\//i.test(c);n+=l?'<p class="mb-1"><strong>Access Token:</strong> <a href="'.concat(c,'" target="_blank">Open token URL</a></p>'):'<p class="mb-1"><strong>Access Token:</strong> <code id="inline-token">'.concat(c,'</code> <button class="btn btn-sm btn-outline-secondary ms-2" id="copy-inline-token">Copy</button></p>')}n+='<div class="mt-3"><a class="btn btn-sm btn-primary me-2" href="'.concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/view">View details</a><a class="btn btn-sm btn-outline-secondary" href="').concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/direct" target="_blank">Direct login</a></div>'),t.metadata&&t.metadata.length&&(n+='<hr><h6>Metadata</h6><div class="small">',t.metadata.forEach(function(t){var e=t.value;try{e=JSON.parse(t.value),e=JSON.stringify(e)}catch(t){}n+='<div class="mb-1"><strong>'.concat(t.key,':</strong> <code style="white-space:pre-wrap">').concat(e,"</code></div>")}),n+="</div>"),o.innerHTML=n;var r=document.getElementById("copy-inline-token");r&&r.addEventListener("click",function(){navigator.clipboard.writeText(document.getElementById("inline-token").textContent),r.innerText="Copied",setTimeout(function(){return r.innerText="Copy"},1500)})}}(t)}).catch(function(){window.location.href=window.AgentConfig.urls.shopsBase+"/"+n.id+"/view"})}),a.appendChild(i)}))}).catch(function(){a&&(a.innerHTML="")})},250)}),document.addEventListener("click",function(t){var e;null!==(e=document.querySelector(".agent-search-wrapper"))&&void 0!==e&&e.contains(t.target)||a&&(a.innerHTML="")}),e.addEventListener("keydown",function(t){if("Enter"===t.key){var n=e.value.trim();window.location.href=window.AgentConfig.urls.shopsRoute+"?q="+encodeURIComponent(n)}}),null==i||i.addEventListener("click",function(){e.value="",a.innerHTML="",null==s||s.classList.add("d-none"),o&&(o.innerHTML="")}),d(),t(window.AgentConfig.urls.shopsRecent).then(function(t){return u(t)}).catch(function(){t(window.AgentConfig.urls.shopsSearch+"?limit=6").then(function(t){return u(t)}).catch(function(){})}),t(window.AgentConfig.urls.shopsLatestInstalls).then(function(t){var e=document.getElementById("latest-installs-list");e&&(e.innerHTML="",t.length||(e.innerHTML='<li class="list-group-item text-muted">No recent installs</li>'),t.forEach(function(t){var n=document.createElement("li");n.className="list-group-item",n.innerHTML='<div class="d-flex justify-content-between"><div><a href="'.concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/view">').concat(t.shop,'</a><div class="small text-muted">').concat(t.domain||"",'</div></div><div class="small text-muted">').concat(new Date(t.installed_at).toLocaleString(),"</div></div>"),e.appendChild(n)}))}).catch(function(){var t=document.getElementById("latest-installs-list");t&&(t.innerHTML='<li class="list-group-item text-muted">Error loading</li>')}),t(window.AgentConfig.urls.shopsLatestUninstalls).then(function(t){var e=document.getElementById("latest-uninstalls-list");e&&(e.innerHTML="",t.length||(e.innerHTML='<li class="list-group-item text-muted">No recent uninstalls</li>'),t.forEach(function(t){var n=document.createElement("li");n.className="list-group-item";var a=t.uninstalled_at||t.deleted_at||null,s=a?new Date(a).toLocaleString():"Unknown";n.innerHTML='<div class="d-flex justify-content-between"><div><a href="'.concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/view">').concat(t.shop,'</a><div class="small text-muted">').concat(t.domain||"",'</div></div><div class="small text-danger">').concat(s,"</div></div>"),e.appendChild(n)}))}).catch(function(){var t=document.getElementById("latest-uninstalls-list");t&&(t.innerHTML='<li class="list-group-item text-muted">Error loading</li>')}),(n=document.querySelector("#subscription-shops-table tbody"))&&t(window.AgentConfig.urls.shopsSearch+"?limit=8").then(function(t){var e=t.items||t||[];n.innerHTML="",e.length?e.forEach(function(t){var e=document.createElement("tr"),a=t.name||t.shop||"â€”",s=t.domain||"",o=t.activeCharge&&t.activeCharge.name||t.plan&&t.plan.name||"â€”",i=[];i.push('<a class="btn btn-sm btn-outline-primary me-1" href="'.concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/view">View</a>')),i.push('<a class="btn btn-sm btn-outline-secondary me-1" href="https://'.concat(s||t.shop,'" target="_blank">Open</a>')),i.push('<a class="btn btn-sm btn-outline-success me-1" href="'.concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/direct" target="_blank">Direct login</a>')),i.push('<a class="btn btn-sm btn-outline-dark" href="'.concat(window.AgentConfig.urls.ticketsRoute,"?shop=").concat(encodeURIComponent(t.shop||t.domain||""),'">Ticket</a>')),e.innerHTML="<td><strong>".concat(a,'</strong><div class="small text-muted">ID ').concat(t.id,'</div></td><td class="d-none d-md-table-cell">').concat(s,"</td><td>").concat(o,'</td><td class="text-end">').concat(i.join(""),"</td>"),n.appendChild(e)}):n.innerHTML='<tr><td colspan="4" class="text-muted">No shops found</td></tr>'}).catch(function(){var t=document.querySelector("#subscription-shops-table tbody");t&&(t.innerHTML='<tr><td colspan="4" class="text-muted">Unable to load</td></tr>')}),setInterval(d,3e5)}function d(){if(l){var e,n,a=function(){t(window.AgentConfig.urls.shopsStats).then(function(t){var e=t.labels||(t.map?t.map(function(t){return t.label}):[]),n=t.installs||(t.map?t.map(function(t){return t.installs||0}):[]),a=t.uninstalls||(t.map?t.map(function(t){return t.uninstalls||0}):[]);!e.length&&Array.isArray(t)&&t.length&&t.forEach(function(t){e.push(t.date||t.label||""),n.push(t.installs||0),a.push(t.uninstalls||0)});var s={type:"line",data:{labels:e,datasets:[{label:"Installs",data:n,borderColor:"#198754",backgroundColor:"rgba(25,135,84,0.08)",tension:.2},{label:"Uninstalls",data:a,borderColor:"#dc3545",backgroundColor:"rgba(220,53,69,0.06)",tension:.2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}},scales:{x:{ticks:{maxRotation:0}},y:{beginAtZero:!0}}}};if(window._agentActivityChart)try{window._agentActivityChart.destroy()}catch(t){}window._agentActivityChart=new Chart(l,s)}).catch(function(){var t=l.closest(".card-body");if(t){t.querySelector("canvas").style.display="none";var e=t.querySelector(".text-muted.placeholder");e||((e=document.createElement("div")).className="text-muted placeholder",e.innerText="No activity data available.",t.appendChild(e))}})};"undefined"==typeof Chart?(e=a,(n=document.createElement("script")).src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js",n.async=!0,n.onload=e,n.onerror=e,document.head.appendChild(n)):a()}}function u(t){if(c){if(c.innerHTML="",!Array.isArray(t)||!t.length){var e=document.createElement("tr");return e.innerHTML='<td colspan="4" class="text-muted small">No recent shops</td>',void c.appendChild(e)}t.slice(0,6).forEach(function(t){var e=document.createElement("tr"),n=t.name||t.shop||"â€”",a=t.domain||"",s=t.plan&&t.plan.name||t.plan||"â€”",o=t.uninstalled||t.is_uninstalled||!1,i=t.uninstalled_at||t.deleted_at||null,l=o?'<span class="badge bg-danger">Uninstalled</span>':'<span class="badge bg-success">Active</span>',r=i?'<div class="small text-muted">'+new Date(i).toLocaleString()+"</div>":"";e.innerHTML='<td><a href="'.concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/view">').concat(n,'</a></td><td class="d-none d-md-table-cell">').concat(a,'</td><td class="d-none d-lg-table-cell">').concat(s,'</td><td class="text-end">').concat(l).concat(r,"</td>"),c.appendChild(e)})}}}()}catch(t){}try{!function(){var e=document.getElementById("shops-search");if(e){var n=document.getElementById("shops-plan"),a=document.getElementById("shops-search-btn"),s=document.getElementById("shops-clear-btn"),o=document.querySelector("#shops-table tbody"),i=document.getElementById("shops-pagination"),c=1;a.addEventListener("click",function(){c=1,l(e.value.trim(),n.value.trim(),1,document.getElementById("shops-status").value)}),s.addEventListener("click",function(){e.value="",n.value="",document.getElementById("shops-status").value="",c=1,l("","",1)}),e.addEventListener("keydown",function(t){"Enter"===t.key&&(t.preventDefault(),a.click())}),n.addEventListener("keydown",function(t){"Enter"===t.key&&(t.preventDefault(),a.click())}),document.getElementById("shops-status").addEventListener("change",function(){c=1,l(e.value.trim(),n.value.trim(),1,this.value)}),l(),document.querySelector("#shops-table tbody").addEventListener("click",function(t){var e=t.target.closest(".copy-domain");if(e){var n=e.getAttribute("data-domain")||"";navigator.clipboard.writeText(n).then(function(){var t=e.innerText;e.innerText="Copied",setTimeout(function(){return e.innerText=t},1200)}).catch(function(){return alert("Copy failed")})}})}function l(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",u=new URL(window.AgentConfig.urls.shopsSearch,window.location.origin);a&&u.searchParams.set("q",a),s&&u.searchParams.set("plan",s),d&&u.searchParams.set("status",d),u.searchParams.set("page",r),u.searchParams.set("limit",15),o&&(o.innerHTML='<tr><td colspan="6" class="text-muted">Loading...</td></tr>'),t(u.toString()).then(function(t){var a;a=t.items||t||[],o&&(o.innerHTML="",Array.isArray(a)&&a.length?a.forEach(function(t){var e=document.createElement("tr"),n=t.name||t.shop||"â€”",a=t.domain||"",s=t.plan&&t.plan.name||t.plan||"â€”",i=t.uninstalled?'<span class="badge bg-danger">Uninstalled</span>':'<span class="badge bg-success">Installed</span>',c=t.uninstalled_at||t.deleted_at||null,l=c?new Date(c).toLocaleString():"â€”",r=[];r.push('<a class="btn btn-sm btn-outline-primary me-1" href="'.concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/view">View</a>')),r.push('<a class="btn btn-sm btn-outline-success me-1" href="'.concat(window.AgentConfig.urls.shopsBase,"/").concat(t.id,'/direct" target="_blank">Direct</a>')),r.push('<a class="btn btn-sm btn-outline-secondary me-1" href="https://'.concat(a||t.shop,'" target="_blank">Open</a>')),r.push('<button class="btn btn-sm btn-outline-dark copy-domain" data-domain="'.concat(a||t.shop,'">Copy</button>'));var d=r.join("");e.innerHTML="<td>".concat(t.id,"</td><td>").concat(n,'</td><td class="d-none d-md-table-cell">').concat(a,'</td><td class="d-none d-lg-table-cell">').concat(s,"</td><td>").concat(i,'</td><td class="d-none d-lg-table-cell">').concat(l,'</td><td class="text-end">').concat(d,"</td>"),o.appendChild(e)}):o.innerHTML='<tr><td colspan="7" class="text-muted">No shops found</td></tr>'),function(t){if(i){i.innerHTML="";var a=t.total||t.meta&&t.meta.total||0,s=t.per_page||t.meta&&t.meta.per_page||15,o=t.current_page||t.meta&&t.meta.current_page||c,r=t.last_page||t.meta&&t.meta.last_page||Math.max(1,Math.ceil(a/s)),d=document.createElement("li");d.className="page-item "+(o<=1?"disabled":""),d.innerHTML='<a class="page-link" href="#" data-page="'.concat(o-1,'">Previous</a>'),i.appendChild(d);for(var u=1;u<=Math.min(r,7);u++){var m=document.createElement("li");m.className="page-item "+(u===o?"active":""),m.innerHTML='<a class="page-link" href="#" data-page="'.concat(u,'">').concat(u,"</a>"),i.appendChild(m)}var p=document.createElement("li");p.className="page-item "+(o>=r?"disabled":""),p.innerHTML='<a class="page-link" href="#" data-page="'.concat(o+1,'">Next</a>'),i.appendChild(p),i.querySelectorAll("a.page-link").forEach(function(t){t.addEventListener("click",function(t){t.preventDefault();var a=Number(this.getAttribute("data-page"))||1;a<1||(c=a,l(e.value.trim(),n.value.trim(),c))})})}}(t)}).catch(function(t){o&&(o.innerHTML='<tr><td colspan="6" class="text-danger">Error loading results</td></tr>'),i&&(i.innerHTML="")})}}()}catch(t){}try{!function(){document.querySelectorAll(".show_more").forEach(function(t){return t.addEventListener("click",function(){return t.classList.toggle("no-max-height")})});var t=document.getElementById("myInput"),e=document.getElementById("myTable");t&&e&&t.addEventListener("input",function(){var n=t.value.trim().toLowerCase();e.querySelectorAll("tbody tr").forEach(function(t){var e=t.textContent.toLowerCase();t.style.display=""===n||-1!==e.indexOf(n)?"":"none"})});var n=(document.querySelector('select[name="level"]')||{}).value||"";if(n){var a=document.querySelector(".label_selector");a&&(a.value=n)}document.querySelectorAll(".copy-log").forEach(function(t){t.addEventListener("click",function(){var t=this,e=this.getAttribute("data-message")||"";navigator.clipboard.writeText(e).then(function(){var e=t.innerText;t.innerText="Copied",setTimeout(function(){return t.innerText=e},1400)}).catch(function(){alert("Copy failed")})})})}()}catch(t){}try{document.querySelectorAll(".copy-field").forEach(function(t){return t.addEventListener("click",function(){var t=this,e=this.getAttribute("data-value")||"";navigator.clipboard.writeText(e).then(function(){var e=t.innerText;t.innerText="Copied",setTimeout(function(){return t.innerText=e},1200)}).catch(function(){return alert("Copy failed")})})})}catch(t){}try{document.querySelectorAll(".toggle-ticket-details").forEach(function(t){return t.addEventListener("click",function(){var t=this.closest("tr");if(t){var e=t.nextElementSibling;e&&(e.style.display="none"===e.style.display||""===e.style.display?"":"none")}})})}catch(t){}})}();